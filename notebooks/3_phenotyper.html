
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Drug Resistant Phenotypes inference (phenotyper) &#8212; Pf6+ User Guide</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.e8f53015daec13862f6db5e763c41738.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Drug Resistant variants visualisation" href="2_variants_prevalence.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      <img src="../_static/mgen_pf6_logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Pf6+ User Guide</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../landing-page.html">
   Pf6+ data user guide
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Pf6+
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="2_variants_prevalence.html">
   Drug Resistant variants visualisation
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Drug Resistant Phenotypes inference
   <em>
    (phenotyper)
   </em>
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/notebooks/3_phenotyper.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/malariagen/Pf6plus"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/malariagen/Pf6plus/issues/new?title=Issue%20on%20page%20%2Fnotebooks/3_phenotyper.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/malariagen/Pf6plus/master?urlpath=lab/tree/pf6plus_documentation/notebooks/3_phenotyper.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/malariagen/Pf6plus/blob/master/pf6plus_documentation/notebooks/3_phenotyper.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="../_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#setup">
   Setup
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#running-on-colab">
     Running on Colab
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#using-your-own-grc">
       Using Your Own GRC
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#uploading-from-your-local-machine">
         Uploading from your local machine
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#upload-from-google-drive">
         Upload from Google Drive
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#running-locally">
     Running Locally
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id1">
       Using Your Own GRC
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#run-the-phenotyper">
   Run the Phenotyper
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#explore-the-detailed-output">
   Explore the detailed output
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#what-s-next">
   What’s next?
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#further-technical-details-when-using-phenotyper">
   Further technical details when using phenotyper
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#rule-example">
     Rule example
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#technicalities">
     Technicalities
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <p><strong>We would like to thank all MalariaGEN Plasmodium falciparum Community Project partners for their contribution. If you use this resource please remember to also site the following studies:</strong>
<a class="reference external" href="http://ngs.sanger.ac.uk/production/malaria/pfcommunityproject/Pf6/Pf_6_partner_studies.pdf">Pf6 partner studies</a> and <a class="reference external" href="http://ngs.sanger.ac.uk/production/malaria/Resource/29/20200705-GenRe-07-PartnerStudyInformation-0.39.pdf">GenRe partner studies</a>.</p>
<div class="section" id="drug-resistant-phenotypes-inference-phenotyper">
<h1>Drug Resistant Phenotypes inference <em>(phenotyper)</em><a class="headerlink" href="#drug-resistant-phenotypes-inference-phenotyper" title="Permalink to this headline">¶</a></h1>
<p>This notebook allows you to use <code class="docutils literal notranslate"><span class="pre">phenotyper</span></code>, a tool to infer drug resistance status from genetic data. In brief, the tool applies a collection of rules, which have been curated from the literature, to determine if a set of genotypes confer resistance to a particular drug. Although we provide an up-to-date list of phenotyping rules (as a JSON file), the user can create his/her own rules or adopt rules from a different source.</p>
<p>Please see <code class="docutils literal notranslate"><span class="pre">https://gitlab.internal.sanger.ac.uk/dt5/phenotyper</span></code> to explore the complete documentation.</p>
<p><strong>When to use <code class="docutils literal notranslate"><span class="pre">phenotyper</span></code>?</strong> When your Genetic Report Card (GRC) doesn’t have information regarding resistant phenotypes or you would like to update previous inferred phenotypes with new rules. Note that any file with information on genotypes (as described below) can be used with <code class="docutils literal notranslate"><span class="pre">phenotyper</span></code> to infer drug resistance status.\n”</p>
<p><strong>How to use?</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Usage</span><span class="p">:</span> <span class="o">./</span><span class="n">phenotyper</span><span class="o">.</span><span class="n">r</span> <span class="p">[</span><span class="n">options</span><span class="p">]</span>
<span class="n">Evaluates</span> <span class="n">a</span> <span class="nb">set</span> <span class="n">of</span> <span class="n">phenotyping</span> <span class="n">rules</span> <span class="n">on</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">samples</span> <span class="n">of</span> <span class="n">the</span> <span class="n">given</span> <span class="n">data</span> <span class="n">file</span><span class="o">.</span>

<span class="n">Options</span><span class="p">:</span>
        <span class="o">--</span><span class="n">datafile</span><span class="o">=</span><span class="n">DATAFILE</span>
                <span class="n">Path</span> <span class="n">to</span> <span class="n">the</span> <span class="n">data</span> <span class="n">file</span><span class="p">,</span> <span class="n">a</span> <span class="n">tabular</span> <span class="n">file</span> <span class="k">with</span> <span class="n">the</span> <span class="n">required</span> <span class="n">fields</span> <span class="p">(</span><span class="n">first</span> <span class="n">column</span> <span class="n">reserverd</span> <span class="k">for</span> <span class="n">sample</span> <span class="n">names</span><span class="p">)</span><span class="o">.</span>

        <span class="o">--</span><span class="n">rulesfile</span><span class="o">=</span><span class="n">RULESFILE</span>
                <span class="n">Path</span> <span class="n">to</span> <span class="n">the</span> <span class="n">JSON</span> <span class="n">file</span> <span class="n">that</span> <span class="n">encodes</span> <span class="n">the</span> <span class="n">rules</span> <span class="n">to</span> <span class="n">be</span> <span class="n">used</span> <span class="k">for</span> <span class="n">evaluating</span> <span class="n">each</span> <span class="n">drug</span><span class="o">.</span>

        <span class="o">--</span><span class="n">ruleout</span><span class="o">=</span><span class="n">RULEOUT</span>
                <span class="n">The</span> <span class="n">field</span> <span class="n">to</span> <span class="n">be</span> <span class="n">extracted</span> <span class="kn">from</span> <span class="nn">a</span> <span class="n">rule</span> <span class="n">when</span> <span class="n">evaluated</span> <span class="k">as</span> <span class="n">true</span><span class="o">.</span> <span class="n">Helps</span> <span class="k">with</span> <span class="n">debugging</span><span class="o">.</span>

        <span class="o">--</span><span class="n">samplefield</span><span class="o">=</span><span class="n">SAMPLEFIELD</span>
                <span class="n">The</span> <span class="n">field</span> <span class="n">on</span> <span class="n">the</span> <span class="n">data</span> <span class="n">file</span> <span class="n">that</span> <span class="n">designates</span> <span class="n">the</span> <span class="n">sample</span> <span class="nb">id</span> <span class="p">(</span><span class="n">optional</span><span class="p">)</span><span class="o">.</span>

        <span class="o">--</span><span class="n">verbose</span>
                <span class="n">A</span> <span class="n">flag</span> <span class="n">to</span> <span class="n">obtain</span> <span class="n">verbose</span> <span class="n">detailed</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">output</span> <span class="p">(</span><span class="n">can</span> <span class="n">generate</span> <span class="n">very</span> <span class="n">big</span> <span class="n">logs</span><span class="p">,</span> <span class="k">for</span> <span class="n">tracebacks</span><span class="p">)</span><span class="o">.</span>

        <span class="o">--</span><span class="n">output</span><span class="o">=</span><span class="n">OUTPUT</span>
                <span class="n">Base</span> <span class="n">path</span> <span class="k">for</span> <span class="n">the</span> <span class="n">output</span> <span class="n">files</span><span class="o">.</span>

        <span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="o">--</span><span class="n">help</span>
                <span class="n">Show</span> <span class="n">this</span> <span class="n">help</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">exit</span>
</pre></div>
</div>
<p><strong>Which are the required fields for <code class="docutils literal notranslate"><span class="pre">--datafile</span></code> ?</strong> You will need a tabulated file with the following fields:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">crt_76</span><span class="p">[</span><span class="n">K</span><span class="p">]</span>       <span class="n">crt_72</span><span class="o">-</span><span class="mi">76</span><span class="p">[</span><span class="n">CVMNK</span><span class="p">]</span>        <span class="n">dhfr_51</span><span class="p">[</span><span class="n">N</span><span class="p">]</span>      <span class="n">dhfr_59</span><span class="p">[</span><span class="n">C</span><span class="p">]</span>      <span class="n">dhfr_108</span><span class="p">[</span><span class="n">S</span><span class="p">]</span>     <span class="n">dhfr_164</span><span class="p">[</span><span class="n">I</span><span class="p">]</span>     <span class="n">dhps_437</span><span class="p">[</span><span class="n">G</span><span class="p">]</span>     <span class="n">dhps_540</span><span class="p">[</span><span class="n">K</span><span class="p">]</span>     <span class="n">dhps_581</span><span class="p">[</span><span class="n">A</span><span class="p">]</span>     <span class="n">dhps_613</span><span class="p">[</span><span class="n">A</span><span class="p">]</span>     <span class="n">k13_class</span>       <span class="n">k13_alleles</span>     <span class="n">mdr1_dup_call</span>   <span class="n">pm2_dup_call</span>    <span class="n">gch1_dup_call</span> 
</pre></div>
</div>
<p>As you can see there is no need for your file to include any further metadata such as location; given that the <strong>phenotyper</strong> only uses genetic data for the inference. Just make sure that you have keep sample_ids from our output file, so you can cross-reference it with other metadata you might have.</p>
<p>An example of the complete file used can be found on our example file <code class="docutils literal notranslate"><span class="pre">mygrc_metadata_nophenotypes.tsv</span></code>. If you have your GRC, this tool will create this file for you, before moving on to the phenotype prediction</p>
<p><strong>What can I do with the output?</strong> An easy way to visualise your results, is by using <code class="docutils literal notranslate"><span class="pre">2_prevalence_DR.ipynb</span></code>; where you can also compare your data against Pf6+ (a public resource which combines information on over 13,000 samples worldwide), increasing the power of your data.</p>
<p>If you are happy to use the default rules we’ve generated, you can continue with the procedure explained here; otherwise, please check the <code class="docutils literal notranslate"><span class="pre">Further</span> <span class="pre">technical</span> <span class="pre">details</span></code> section below.</p>
<div class="section" id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h2>
<p>Download the phenotyper tool if you haven’t already</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#TO DO: this will only work once the phenotyper repo has been made public</span>
<span class="o">!</span>git clone https://github.com/malariagen/phenotyper.git
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cloning into &#39;phenotyper&#39;...
Username for &#39;https://github.com&#39;: ^C
</pre></div>
</div>
</div>
</div>
<p>Below we set the paths to the phenotyper.r script, the example GRC, the rules file, and the output file containing the phenotypes. <code class="docutils literal notranslate"><span class="pre">PATH_TO_PHENOTYPER</span></code>, <code class="docutils literal notranslate"><span class="pre">PATH_TO_GRC</span></code>, and <code class="docutils literal notranslate"><span class="pre">PATH_TO_RULES</span></code> are set to the files cloned from git above (You may need to change the paths if you downloaded the phenotyper somewhere else). Please set <code class="docutils literal notranslate"><span class="pre">PATH_TO_OUTPUT</span></code> to the path of the file you would like the phenotyper to create and put the output in.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#SET VARIABLES FOR RUNNING PHENOTYPER HERE </span>
<span class="o">%</span><span class="k">env</span> PATH_TO_PHENOTYPER=./phenotyper/phenotyper.r 
<span class="o">%</span><span class="k">env</span> PATH_TO_GRC=./phenotyper/ext/fake_grc/mygrc_metadata_genotypes.tsv
<span class="o">%</span><span class="k">env</span> PATH_TO_RULES=./phenotyper/ext/rules/test_rules_310821.json
<span class="o">%</span><span class="k">env</span> PATH_TO_OUTPUT=#Enter path to output file you would like to create
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>env: PATH_TO_PHENOTYPER=./phenotyper/phenotyper.r
env: PATH_TO_GRC=./phenotyper/ext/fake_grc/mygrc_metadata_genotypes.tsv
env: PATH_TO_RULES=./phenotyper/ext/rules/test_rules_310821.json
env: PATH_TO_OUTPUT=#Enter path to output file you would like to create
</pre></div>
</div>
</div>
</div>
<p>Running the following will allow you to run R and install the dependencies that you need to run the phenotyper tool.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#required to use R inside the Jupyter Notebook</span>
<span class="o">%</span><span class="k">load_ext</span> rpy2.ipython
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The rpy2.ipython extension is already loaded. To reload it, use:
  %reload_ext rpy2.ipython
</pre></div>
</div>
</div>
</div>
<p>Install R dependencies for phenotyper</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">R</span> 

install.packages(&#39;optparse&#39;, quiet = TRUE)
install.packages(&#39;stringr&#39;, quiet = TRUE)
install.packages(&#39;stringi&#39;, quiet = TRUE)
install.packages(&#39;jsonlite&#39;, quiet = TRUE)
</pre></div>
</div>
</div>
</div>
<div class="section" id="running-on-colab">
<h3>Running on Colab<a class="headerlink" href="#running-on-colab" title="Permalink to this headline">¶</a></h3>
<p>If you are running the notebooks on colab then run the cell below to clone the python code needed for the plots below</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>git clone https://github.com/malariagen/Pf6plus.git 
<span class="o">!</span>cp -r /content/Pf6plus/pf6plus_documentation/notebooks/data_analysis .
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cloning into &#39;Pf6plus&#39;...
Username for &#39;https://github.com&#39;: ^C
cp: /content/Pf6plus/pf6plus_documentation/notebooks/data_analysis: No such file or directory
</pre></div>
</div>
</div>
</div>
<div class="section" id="using-your-own-grc">
<h4>Using Your Own GRC<a class="headerlink" href="#using-your-own-grc" title="Permalink to this headline">¶</a></h4>
<p>We have already set the <code class="docutils literal notranslate"><span class="pre">PATH_TO_GRC</span></code> above to the example included in the phenotyper repository. If you would like to use your own you can overide this below by uploading from your own machine or from your google drive.</p>
<div class="section" id="uploading-from-your-local-machine">
<h5>Uploading from your local machine<a class="headerlink" href="#uploading-from-your-local-machine" title="Permalink to this headline">¶</a></h5>
<p>You can upload a GRC from your own machine to run the phenotyper. Run the following and select the file from your local machine.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">google.colab</span> <span class="kn">import</span> <span class="n">files</span>
<span class="n">uploaded</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">upload</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">vc</span><span class="o">/</span><span class="mi">78</span><span class="n">lppctx4y58zg88d0xyjydr000lw0</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_43998</span><span class="o">/</span><span class="mf">2535520808.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="kn">from</span> <span class="nn">google.colab</span> <span class="kn">import</span> <span class="n">files</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">uploaded</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">upload</span><span class="p">()</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;google.colab&#39;
</pre></div>
</div>
</div>
</div>
<p>Once the file has been uploaded you should see the path, copy this into the cell below</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> PATH_TO_GRC=#Enter the path here
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="upload-from-google-drive">
<h5>Upload from Google Drive<a class="headerlink" href="#upload-from-google-drive" title="Permalink to this headline">¶</a></h5>
<p>To use a file that is stored on your google drive first connect to your personal google drive by running the cell below and following the instructions that are output.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">google.colab</span> <span class="kn">import</span> <span class="n">drive</span>
<span class="n">drive</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="s1">&#39;/content/drive&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Copy the GRC to google colab by running the following, replacing <code class="docutils literal notranslate"><span class="pre">&lt;Path</span> <span class="pre">to</span> <span class="pre">GRC</span> <span class="pre">on</span> <span class="pre">your</span> <span class="pre">drive&gt;</span></code> with the path where your file is stored on your google drive.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>cp -r &lt;Path to GRC on your drive&gt; .
</pre></div>
</div>
</div>
</div>
<p>Finally, run the following to set PATH_TO_GRC to where your GRC is stored on google colab.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> PATH_TO_GRC=/content/drive/&lt;GRC file name&gt;
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="running-locally">
<h3>Running Locally<a class="headerlink" href="#running-locally" title="Permalink to this headline">¶</a></h3>
<p>There are some steps you need to follow before opening the notebooks to run them locally. If you haven’t already, please follow these <a class="reference external" href="https://gitlab.com/malariagen/gsp/pf6plus/-/tree/add_jupyter_notebooks/notebooks#running-locally">instructions</a>.</p>
<div class="section" id="id1">
<h4>Using Your Own GRC<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p>We have already set <code class="docutils literal notranslate"><span class="pre">PATH_TO_GRC</span></code> above to use the example in the phenotyper repository. If you would like to use your own please set the path to the GRC you would like to use below:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> PATH_TO_GRC=#Path to GRC 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>env: PATH_TO_GRC=#Path to GRC
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="run-the-phenotyper">
<h2>Run the Phenotyper<a class="headerlink" href="#run-the-phenotyper" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">--verbose</span></code> returns an execution log; which is useful to document and track how the samples have been classified</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import packages to visualise results</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">data_analysis.plot_dr_prevalence</span> <span class="kn">import</span> <span class="n">plot_phenotype_bar_chart_compared_to_pf6plus</span>
<span class="kn">from</span> <span class="nn">data_analysis.map_samples</span> <span class="kn">import</span> <span class="n">map_samples</span>
<span class="kn">import</span> <span class="nn">bokeh.io</span>
<span class="kn">import</span> <span class="nn">os</span> 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>! $PATH_TO_PHENOTYPER \
  --datafile $PATH_TO_GRC  \
  --rulesfile $PATH_TO_RULES \
  --ruleout phenotype \
  --output $PATH_TO_OUTPUT \
  --verbose 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/bin/bash: --datafile: command not found
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="explore-the-detailed-output">
<h2>Explore the detailed output<a class="headerlink" href="#explore-the-detailed-output" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import results from Phenotyper run above</span>
<span class="n">phenotyper_results</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_TO_OUTPUT&#39;</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">phenotyper_results</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

<span class="c1"># import pf6+ data </span>
<span class="n">pf6plus_metadata</span> <span class="o">=</span> <span class="s1">&#39;https://pf6plus.cog.sanger.ac.uk/pf6plus_metadata.tsv&#39;</span>
<span class="n">pf6plus</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">pf6plus_metadata</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># import GRC </span>
<span class="n">grc_metadata</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_TO_GRC&#39;</span><span class="p">)</span>
<span class="n">grc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">grc_metadata</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ValueError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">vc</span><span class="o">/</span><span class="mi">78</span><span class="n">lppctx4y58zg88d0xyjydr000lw0</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_1246</span><span class="o">/</span><span class="mf">4081404360.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1"># import results from Phenotyper run above</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">phenotyper_results</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_TO_OUTPUT&#39;</span><span class="p">)</span>
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">phenotyper_results</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> 
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="c1"># import pf6+ data</span>

<span class="nn">~/homebrew/lib/python3.9/site-packages/pandas/util/_decorators.py</span> in <span class="ni">wrapper</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">309</span>                     <span class="n">stacklevel</span><span class="o">=</span><span class="n">stacklevel</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">310</span>                 <span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">311</span>             <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">312</span> 
<span class="g g-Whitespace">    </span><span class="mi">313</span>         <span class="k">return</span> <span class="n">wrapper</span>

<span class="nn">~/homebrew/lib/python3.9/site-packages/pandas/io/parsers/readers.py</span> in <span class="ni">read_csv</span><span class="nt">(filepath_or_buffer, sep, delimiter, header, names, index_col, usecols, squeeze, prefix, mangle_dupe_cols, dtype, engine, converters, true_values, false_values, skipinitialspace, skiprows, skipfooter, nrows, na_values, keep_default_na, na_filter, verbose, skip_blank_lines, parse_dates, infer_datetime_format, keep_date_col, date_parser, dayfirst, cache_dates, iterator, chunksize, compression, thousands, decimal, lineterminator, quotechar, quoting, doublequote, escapechar, comment, encoding, encoding_errors, dialect, error_bad_lines, warn_bad_lines, on_bad_lines, delim_whitespace, low_memory, memory_map, float_precision, storage_options)</span>
<span class="g g-Whitespace">    </span><span class="mi">584</span>     <span class="n">kwds</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwds_defaults</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">585</span> 
<span class="ne">--&gt; </span><span class="mi">586</span>     <span class="k">return</span> <span class="n">_read</span><span class="p">(</span><span class="n">filepath_or_buffer</span><span class="p">,</span> <span class="n">kwds</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">587</span> 
<span class="g g-Whitespace">    </span><span class="mi">588</span> 

<span class="nn">~/homebrew/lib/python3.9/site-packages/pandas/io/parsers/readers.py</span> in <span class="ni">_read</span><span class="nt">(filepath_or_buffer, kwds)</span>
<span class="g g-Whitespace">    </span><span class="mi">480</span> 
<span class="g g-Whitespace">    </span><span class="mi">481</span>     <span class="c1"># Create the parser.</span>
<span class="ne">--&gt; </span><span class="mi">482</span>     <span class="n">parser</span> <span class="o">=</span> <span class="n">TextFileReader</span><span class="p">(</span><span class="n">filepath_or_buffer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">483</span> 
<span class="g g-Whitespace">    </span><span class="mi">484</span>     <span class="k">if</span> <span class="n">chunksize</span> <span class="ow">or</span> <span class="n">iterator</span><span class="p">:</span>

<span class="nn">~/homebrew/lib/python3.9/site-packages/pandas/io/parsers/readers.py</span> in <span class="ni">__init__</span><span class="nt">(self, f, engine, **kwds)</span>
<span class="g g-Whitespace">    </span><span class="mi">809</span>             <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;has_index_names&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwds</span><span class="p">[</span><span class="s2">&quot;has_index_names&quot;</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">810</span> 
<span class="ne">--&gt; </span><span class="mi">811</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_engine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">812</span> 
<span class="g g-Whitespace">    </span><span class="mi">813</span>     <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="nn">~/homebrew/lib/python3.9/site-packages/pandas/io/parsers/readers.py</span> in <span class="ni">_make_engine</span><span class="nt">(self, engine)</span>
<span class="g g-Whitespace">   </span><span class="mi">1038</span>             <span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1039</span>         <span class="c1"># error: Too many arguments for &quot;ParserBase&quot;</span>
<span class="ne">-&gt; </span><span class="mi">1040</span>         <span class="k">return</span> <span class="n">mapping</span><span class="p">[</span><span class="n">engine</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>  <span class="c1"># type: ignore[call-arg]</span>
<span class="g g-Whitespace">   </span><span class="mi">1041</span> 
<span class="g g-Whitespace">   </span><span class="mi">1042</span>     <span class="k">def</span> <span class="nf">_failover_to_python</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="nn">~/homebrew/lib/python3.9/site-packages/pandas/io/parsers/c_parser_wrapper.py</span> in <span class="ni">__init__</span><span class="nt">(self, src, **kwds)</span>
<span class="g g-Whitespace">     </span><span class="mi">49</span> 
<span class="g g-Whitespace">     </span><span class="mi">50</span>         <span class="c1"># open handles</span>
<span class="ne">---&gt; </span><span class="mi">51</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_open_handles</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">kwds</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">52</span>         <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">handles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="g g-Whitespace">     </span><span class="mi">53</span> 

<span class="nn">~/homebrew/lib/python3.9/site-packages/pandas/io/parsers/base_parser.py</span> in <span class="ni">_open_handles</span><span class="nt">(self, src, kwds)</span>
<span class="g g-Whitespace">    </span><span class="mi">220</span>         <span class="n">Let</span> <span class="n">the</span> <span class="n">readers</span> <span class="nb">open</span> <span class="n">IOHandles</span> <span class="n">after</span> <span class="n">they</span> <span class="n">are</span> <span class="n">done</span> <span class="k">with</span> <span class="n">their</span> <span class="n">potential</span> <span class="n">raises</span><span class="o">.</span>
<span class="g g-Whitespace">    </span><span class="mi">221</span>         <span class="s2">&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">222</span><span class="s2">         self.handles = get_handle(</span>
<span class="g g-Whitespace">    </span><span class="mi">223</span><span class="s2">             src,</span>
<span class="g g-Whitespace">    </span><span class="mi">224</span><span class="s2">             &quot;r&quot;,</span>

<span class="nn">~/homebrew/lib/python3.9/site-packages/pandas/io/common.py</span> in <span class="ni">get_handle</span><span class="nt">(path_or_buf, mode, encoding, compression, memory_map, is_text, errors, storage_options)</span>
<span class="g g-Whitespace">    </span><span class="mi">606</span><span class="s2"> </span>
<span class="g g-Whitespace">    </span><span class="mi">607</span><span class="s2">     # open URLs</span>
<span class="ne">--&gt; </span><span class="mi">608</span><span class="s2">     ioargs = _get_filepath_or_buffer(</span>
<span class="g g-Whitespace">    </span><span class="mi">609</span><span class="s2">         path_or_buf,</span>
<span class="g g-Whitespace">    </span><span class="mi">610</span><span class="s2">         encoding=encoding,</span>

<span class="nn">~/homebrew/lib/python3.9/site-packages/pandas/io/common.py</span> in <span class="ni">_get_filepath_or_buffer</span><span class="nt">(filepath_or_buffer, encoding, compression, mode, storage_options)</span>
<span class="g g-Whitespace">    </span><span class="mi">393</span><span class="s2">     if not is_file_like(filepath_or_buffer):</span>
<span class="g g-Whitespace">    </span><span class="mi">394</span><span class="s2">         msg = f&quot;Invalid file path or buffer object type: {type(filepath_or_buffer)}&quot;</span>
<span class="ne">--&gt; </span><span class="mi">395</span><span class="s2">         raise ValueError(msg)</span>
<span class="g g-Whitespace">    </span><span class="mi">396</span><span class="s2"> </span>
<span class="g g-Whitespace">    </span><span class="mi">397</span><span class="s2">     return IOArgs(</span>

<span class="ne">ValueError</span>: Invalid file path or buffer object type: &lt;class &#39;NoneType&#39;&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bokeh</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">output_notebook</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s map the phenotypes we have found back to the sample metadata</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;SampleId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grc</span><span class="o">.</span><span class="n">index</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;SampleId&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results_with_geo</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">results</span><span class="p">,</span> <span class="n">pf6plus</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The maps below show how including the Pf6+ data can increase the number of samples and the coverage that you have for a country. Click on the icons to find out more</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">map_samples</span><span class="p">(</span><span class="n">results_with_geo</span><span class="p">,</span> <span class="n">zoom_to_start</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">map_samples</span><span class="p">(</span><span class="n">pf6plus</span><span class="p">[</span><span class="n">pf6plus</span><span class="o">.</span><span class="n">Country</span> <span class="o">==</span> <span class="s1">&#39;Mali&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span><span class="n">zoom_to_start</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The plots below compare the phenotypes found for the GRC, which includes samples from Mali, compared to the samples in the Pf6+ dataset that come from Mali.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_phenotype_bar_chart_compared_to_pf6plus</span><span class="p">(</span><span class="n">results</span><span class="p">,</span><span class="n">pf6plus</span><span class="p">[</span><span class="n">pf6plus</span><span class="o">.</span><span class="n">Country</span> <span class="o">==</span> <span class="s1">&#39;Mali&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="what-s-next">
<h2>What’s next?<a class="headerlink" href="#what-s-next" title="Permalink to this headline">¶</a></h2>
<p>After obtaining your results from this tool, you can go back to the <code class="docutils literal notranslate"><span class="pre">2_variants_prevalence.ipynb</span></code> notebook to easily visualise your results and compare them with our Pf6+ dataset, which stores over 13,500 samples with inferred phenotypes, collected across the world.</p>
</div>
<hr class="docutils" />
<div class="section" id="further-technical-details-when-using-phenotyper">
<h2>Further technical details when using phenotyper<a class="headerlink" href="#further-technical-details-when-using-phenotyper" title="Permalink to this headline">¶</a></h2>
<div class="section" id="rule-example">
<h3>Rule example<a class="headerlink" href="#rule-example" title="Permalink to this headline">¶</a></h3>
<p>Drugs are evaluated according to a set of rules specified in a JSON document. The only required fields for a rule are name and evaluation. Within evaluation one can access any of the fields/columns provided in the input data file using an R valid expression (see example below).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;Chloroquine&quot;</span><span class="p">:{</span>
         <span class="s2">&quot;rules&quot;</span><span class="p">:[</span>
            <span class="p">{</span>
               <span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Chloroquine-1&quot;</span><span class="p">,</span>
               <span class="s2">&quot;change&quot;</span><span class="p">:</span><span class="s2">&quot;76-Het&quot;</span><span class="p">,</span>
               <span class="s2">&quot;evaluation&quot;</span><span class="p">:</span><span class="s2">&quot;`crt_76[K]` </span><span class="si">%c</span><span class="s2">ontains% &#39;,&#39;&quot;</span><span class="p">,</span>
               <span class="s2">&quot;interpretation&quot;</span><span class="p">:</span><span class="s2">&quot;Het&quot;</span><span class="p">,</span>
               <span class="s2">&quot;phenotype&quot;</span><span class="p">:</span><span class="s2">&quot;Resistant/het&quot;</span><span class="p">,</span>
               <span class="s2">&quot;analytics&quot;</span><span class="p">:</span><span class="s2">&quot;Resistant&quot;</span>
            <span class="p">},</span>
            <span class="p">{</span>
               <span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Chloroquine-2&quot;</span><span class="p">,</span>
               <span class="s2">&quot;change&quot;</span><span class="p">:</span><span class="s2">&quot;76-Missing&quot;</span><span class="p">,</span>
               <span class="s2">&quot;evaluation&quot;</span><span class="p">:</span><span class="s2">&quot;`crt_76[K]` %==% &#39;-&#39;&quot;</span><span class="p">,</span>
               <span class="s2">&quot;interpretation&quot;</span><span class="p">:</span><span class="s2">&quot;Missing&quot;</span><span class="p">,</span>
               <span class="s2">&quot;phenotype&quot;</span><span class="p">:</span><span class="s2">&quot;Undetermined/missing&quot;</span><span class="p">,</span>
               <span class="s2">&quot;analytics&quot;</span><span class="p">:</span><span class="s2">&quot;Undetermined&quot;</span>
            <span class="p">},</span>
            <span class="p">{</span>
               <span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Chloroquine-3&quot;</span><span class="p">,</span>
               <span class="s2">&quot;change&quot;</span><span class="p">:</span><span class="s2">&quot;K76&quot;</span><span class="p">,</span>
               <span class="s2">&quot;evaluation&quot;</span><span class="p">:</span><span class="s2">&quot;`crt_76[K]` %==% &#39;K&#39;&quot;</span><span class="p">,</span>
               <span class="s2">&quot;interpretation&quot;</span><span class="p">:</span><span class="s2">&quot;WT&quot;</span><span class="p">,</span>
               <span class="s2">&quot;phenotype&quot;</span><span class="p">:</span><span class="s2">&quot;Sensitive&quot;</span><span class="p">,</span>
               <span class="s2">&quot;analytics&quot;</span><span class="p">:</span><span class="s2">&quot;Sensitive&quot;</span>
            <span class="p">},</span>
            <span class="p">{</span>
               <span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Chloroquine-4&quot;</span><span class="p">,</span>
               <span class="s2">&quot;change&quot;</span><span class="p">:</span><span class="s2">&quot;76T&quot;</span><span class="p">,</span>
               <span class="s2">&quot;evaluation&quot;</span><span class="p">:</span><span class="s2">&quot;`crt_76[K]` %==% &#39;T&#39;&quot;</span><span class="p">,</span>
               <span class="s2">&quot;interpretation&quot;</span><span class="p">:</span><span class="s2">&quot;Mutant&quot;</span><span class="p">,</span>
               <span class="s2">&quot;phenotype&quot;</span><span class="p">:</span><span class="s2">&quot;Resistant [1]&quot;</span><span class="p">,</span>
               <span class="s2">&quot;analytics&quot;</span><span class="p">:</span><span class="s2">&quot;Resistant&quot;</span>
            <span class="p">},</span>
            <span class="p">{</span>
               <span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Chloroquine-5&quot;</span><span class="p">,</span>
               <span class="s2">&quot;change&quot;</span><span class="p">:</span><span class="s2">&quot;76-nonT&quot;</span><span class="p">,</span>
               <span class="s2">&quot;evaluation&quot;</span><span class="p">:</span><span class="s2">&quot;T&quot;</span><span class="p">,</span>
               <span class="s2">&quot;interpretation&quot;</span><span class="p">:</span><span class="s2">&quot;Unknown mutant&quot;</span><span class="p">,</span>
               <span class="s2">&quot;phenotype&quot;</span><span class="p">:</span><span class="s2">&quot;Undetermined/unknown&quot;</span><span class="p">,</span>
               <span class="s2">&quot;analytics&quot;</span><span class="p">:</span><span class="s2">&quot;Undetermined&quot;</span>
            <span class="p">}</span>
         <span class="p">]</span>
      <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="technicalities">
<h3>Technicalities<a class="headerlink" href="#technicalities" title="Permalink to this headline">¶</a></h3>
<p>Better to protect field names with backticks (`) in the JSON file as you’ll find weird characters there (for instance they come from Excel files) that will cause havoc in R. One can also do this programmatically by providing a character protection mapping (within the code but not recommended).</p>
<p>The software interprets the rules executing the interpretable R code given in evaluation with some custom-made operators, like %==%, which means loose equality (symmetric any operation, any(a in b) or any(b in a)), to ease the evaluation. When dealing with this kind of task one usually writes a little parser for the operations allowed so no arbitrary code is evaluated. However, as we had to deal with different and changing formatting encodings (e.g. the way hets or missing calls are represented) the prototype evaluates any valid R expression given in the rules. We overwrite R system call functions to prevent attempts of code injection but this is obviously something to bear in mind.</p>
<p>There are metarules that check the output status of a previously executed rule by referencing the name of the drug with &#64;, for instance:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>           <span class="p">{</span>
               <span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Dihydroartemisinin-piperaquine-3&quot;</span><span class="p">,</span>
               <span class="s2">&quot;change&quot;</span><span class="p">:</span><span class="s2">&quot;Missing&quot;</span><span class="p">,</span>
               <span class="s2">&quot;evaluation&quot;</span><span class="p">:</span><span class="s2">&quot;@Artemisinin@ </span><span class="si">%c</span><span class="s2">ontains% &#39;Missing&#39; || @Piperaquine@ </span><span class="si">%c</span><span class="s2">ontains% &#39;Missing&#39;&quot;</span><span class="p">,</span>
               <span class="s2">&quot;interpretation&quot;</span><span class="p">:</span><span class="s2">&quot;Undetermined/Missing&quot;</span><span class="p">,</span>
               <span class="s2">&quot;phenotype&quot;</span><span class="p">:</span><span class="s2">&quot;Missing&quot;</span><span class="p">,</span>
               <span class="s2">&quot;analytics&quot;</span><span class="p">:</span><span class="s2">&quot;Undetermined&quot;</span>
            <span class="p">},</span>
</pre></div>
</div>
<p>One can run the program in –verbose mode and save the log. The file will be huge (and the execution is very slow), but I use it to trace back which rules were executed and why when phenotypes changed or were weird.</p>
<p>#Important things to bear in mind</p>
<ol class="simple">
<li><p>For each drug we define a set of rules that are executed sequentially.</p></li>
<li><p><strong>Order is important</strong> (top-down execution until finding one that evaluates to true).</p></li>
<li><p>There should be always a default catch-up rule at the end (it will be executed if nothing else has been executed. A default rule just evaluates to <code class="docutils literal notranslate"><span class="pre">True</span></code> or <code class="docutils literal notranslate"><span class="pre">T</span></code>.</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>           <span class="p">{</span>
               <span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Chloroquine-5&quot;</span><span class="p">,</span>
               <span class="s2">&quot;change&quot;</span><span class="p">:</span><span class="s2">&quot;76-nonT&quot;</span><span class="p">,</span>
               <span class="s2">&quot;evaluation&quot;</span><span class="p">:</span><span class="s2">&quot;T&quot;</span><span class="p">,</span>
               <span class="s2">&quot;interpretation&quot;</span><span class="p">:</span><span class="s2">&quot;Unknown mutant&quot;</span><span class="p">,</span>
               <span class="s2">&quot;phenotype&quot;</span><span class="p">:</span><span class="s2">&quot;Undetermined/unknown&quot;</span><span class="p">,</span>
               <span class="s2">&quot;analytics&quot;</span><span class="p">:</span><span class="s2">&quot;Undetermined&quot;</span>
            <span class="p">}</span>
</pre></div>
</div>
<ol class="simple">
<li><p>The script will evaluate each rule according to the <code class="docutils literal notranslate"><span class="pre">evaluation</span></code> field (required).</p></li>
<li><p>The output that will be obtained from a rule that evaluated to true must be specified using the <code class="docutils literal notranslate"><span class="pre">--ruleout</span></code> option. This allows for different outputs even when working with the same set of rules. Example: in our current phenotyping rules we made some arbitrary decisions (samples with het resistance markers are considered undetermined instead of resistant, you can imagine a different world where hets are resistant or dominant hets are resistant). However, one can check what difference these decisions make with the same set of rules by providing different output fields and indicating so when calling the program. For instance, using <code class="docutils literal notranslate"><span class="pre">--ruleout</span> <span class="pre">het_phenotype</span></code> instead of <code class="docutils literal notranslate"><span class="pre">--ruleout</span> <span class="pre">phenotype</span></code> (see example rule definition below)</p></li>
</ol>
<div class="highlight-&quot;Chloroquine&quot;:{ notranslate"><div class="highlight"><pre><span></span>         &quot;rules&quot;:[
            {
               &quot;name&quot;:&quot;Chloroquine-1&quot;,
               &quot;change&quot;:&quot;76-Het&quot;,
               &quot;evaluation&quot;:&quot;`PfCRT:76` %==% &#39;K/T&#39; || `PfCRT:76` %==% &#39;I/T&#39;&quot;,
               &quot;het_phenotype&quot;:&quot;Resistant&quot;,
               &quot;phenotype&quot;:&quot;Undetermined&quot;,
               &quot;analytics&quot;:&quot;Resistant/Het&quot;
            }, (...)
</pre></div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    
    <div id="prev">
        <a class="left-prev" href="2_variants_prevalence.html" title="previous page">
            <i class="prevnext-label fas fa-angle-left"></i>
            <div class="prevnext-info">
                <p class="prevnext-label">previous</p>
                <p class="prevnext-title">Drug Resistant variants visualisation</p>
            </div>
        </a>
    </div>

</div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By DT5<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>